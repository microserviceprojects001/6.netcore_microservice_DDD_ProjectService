âœ… å“ªäº›æ“ä½œé€‚åˆèµ°è¿ç§»æµç¨‹ï¼Ÿ

```
æ“ä½œç±»åž‹	                           æ˜¯å¦é€‚åˆèµ° migrations + update æµç¨‹	è¯´æ˜Ž
âœ… æ·»åŠ å­—æ®µ	                        âœ”ï¸ éžå¸¸é€‚åˆ	                         å¸¸è§æ“ä½œ
âœ… åˆ é™¤å­—æ®µ	                       âœ”ï¸ éžå¸¸é€‚åˆ	                         ä¼šè‡ªåŠ¨ç”Ÿæˆ DropColumn
âœ… ä¿®æ”¹å­—æ®µç±»åž‹	                    âœ”ï¸ æ”¯æŒ	                             ä½†æ³¨æ„å¯èƒ½ä¸¢å¤±æ•°æ®
âœ… ä¿®æ”¹å­—æ®µçº¦æŸï¼ˆå¦‚ nullableã€é•¿åº¦ï¼‰	   âœ”ï¸ æ”¯æŒ	                          ä¼šè‡ªåŠ¨è¯†åˆ«å·®å¼‚
âœ… æ·»åŠ æˆ–åˆ é™¤ç´¢å¼•	                  âœ”ï¸ æ”¯æŒ	                         ç”¨ .HasIndex() é…ç½®
âœ… æ·»åŠ æˆ–ä¿®æ”¹è¡¨ä¹‹é—´çš„å…³ç³»ï¼ˆå¤–é”®ï¼‰	     âœ”ï¸ æ”¯æŒ	                        å¯ç”¨ HasOne/WithMany æ˜¾å¼é…ç½®
âœ… æ·»åŠ /åˆ é™¤è¡¨	                   âœ”ï¸ æ”¯æŒ	                                æ–°å»ºç±»åŽç”Ÿæˆè¿ç§»å³å¯
âŒ å˜æ›´æ•°æ®å†…å®¹ï¼ˆå¦‚åˆå§‹æ•°æ®ï¼‰	        âš ï¸ æ”¯æŒéƒ¨åˆ†	                        éœ€é€šè¿‡ migrationBuilder.InsertData() æˆ– Seed() æ–¹å¼æ‰‹åŠ¨å†™
âŒ æ•°æ®åº“ç»“æž„å¤–çš„æ“ä½œï¼ˆå¦‚è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹ï¼‰	âŒ ä¸æŽ¨è	                  å¯ç”¨ Raw SQL + æ‰‹åŠ¨ç»´æŠ¤
```

# å•äººæ“ä½œæ•°æ®åº“æ›´æ–°æ—¶å€™

æ­£å¸¸ä»¥ä¸‹å‘½ä»¤å°±å¯ä»¥äº†

```
1ï¸âƒ£ ä¿®æ”¹æ¨¡åž‹ç±»ï¼ˆModels/ ä¸‹çš„ç±»ï¼‰
       â†“
2ï¸âƒ£ è¿è¡Œï¼š
    dotnet ef migrations add XxxMigrationName -c UserContext
       â†“
3ï¸âƒ£ è¿è¡Œï¼š
    dotnet ef database update -c UserContext
       â†“
4ï¸âƒ£ æ•°æ®åº“ç»“æž„æ›´æ–°
```

# é—®é¢˜

å¦‚æžœæ˜¯æ›´æ–°è¡¨ä¸­å­—æ®µç±»åž‹ï¼Œè€Œä¸”è¡¨ä¸­å·²ç»å­˜åœ¨æ•°æ®äº†

ä¾‹å¦‚ï¼š

åŽŸå§‹å­—æ®µï¼š

```
public string Age { get; set; }  // åŽŸæ¥æ˜¯å­—ç¬¦ä¸²
```

çŽ°åœ¨ä½ æƒ³æ”¹ä¸ºï¼š

```
public int Age { get; set; }     // æ”¹ä¸ºæ•°å­—ç±»åž‹
```

# æ–¹æ¡ˆ

ç¬¬ 1 æ­¥ï¼šç¡®ä¿æ•°æ®å¯è½¬æ¢

```
SELECT Age FROM Users WHERE Age REGEXP '^[0-9]+$' = 0;
```

åˆ—å‡ºæ‰€æœ‰ä¸æ˜¯çº¯æ•°å­—çš„è®°å½•ã€‚

ç¬¬äºŒæ­¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†è¿™äº›æ•°æ®

å¦åˆ™ ä¼šæŠ¥å¦‚ä¸‹è¿ç§»é”™è¯¯

```
dotnet ef database update

Incorrect integer value: 'www' for column 'Age' at row 1
```

# ç»“è®ºï¼šæ•°æ®åº“å­—æ®µç±»åž‹è¦æ›´æ”¹ï¼Œå¿…é¡»ä¿è¯å·²æœ‰æ•°æ® èƒ½æˆåŠŸè½¬æ¢ä¸ºæ–°ç±»åž‹

# å¤šäººå›¢é˜Ÿåˆä½œå¯¹äºŽæ•°æ®åº“æ›´æ–°æ“ä½œçš„æ–¹æ¡ˆ

æˆ‘æ˜¯å›¢é˜Ÿé‡Œçš„æ™®é€šæˆå‘˜ï¼Œæˆ‘è¦æ˜¯æ›´æ–°äº†æ•°æ®åº“æ¨¡åž‹ï¼Œæˆ‘ä¸è¦åŽ»ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼Œæˆ‘éœ€è¦å‘ŠçŸ¥é¢†å¯¼æˆ–è€…ç»Ÿä¸€çš„æ•°æ®åº“ç®¡ç†äººå‘˜ï¼Œæ•°æ®åº“ç®¡ç†äººå‘˜å®šæœŸçš„ç»Ÿä¸€çš„åŽ»ç”Ÿæˆæ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼ŒåŽ»æ›´æ–°æ•°æ®åº“ï¼Ÿ

ðŸ§‘â€ðŸ’» ä½œä¸ºæ™®é€šå¼€å‘è€…ï¼Œä½ è¦åšçš„å°±æ˜¯ï¼š
æ­¥éª¤ è¡Œä¸º
âœ… 1. ä¿®æ”¹ Entity æˆ– DbContext æ¨¡åž‹ æ¯”å¦‚ä½ ç»™ AppUser æ·»åŠ ä¸€ä¸ªå­—æ®µ Age
âœ… 2. æž„å»ºç¡®è®¤æ— è¯­æ³•é—®é¢˜ dotnet build ä¸€ä¸‹ç¡®è®¤æ²¡é—®é¢˜
âœ… 3. ä¸è¦æ‰§è¡Œ dotnet ef migrations addï¼ âŒ ä¸ç”Ÿæˆè¿ç§»æ–‡ä»¶
âœ… 4. æäº¤ä»£ç å¹¶é€šçŸ¥æ•°æ®åº“è´Ÿè´£äºº å‘ä¸ªæ¶ˆæ¯è¯´æ˜Žâ€œæˆ‘æ–°å¢žäº†å­—æ®µ Ageâ€
âœ… 5. ç­‰å¾…ç»Ÿä¸€ç”Ÿæˆè¿ç§» & åº”ç”¨æ›´æ–° CI/CD æˆ–è´Ÿè´£äººç»Ÿä¸€å¤„ç†è¿ç§»å’Œ update

ðŸ‘¨â€ðŸ« æ•°æ®åº“è´Ÿè´£äººï¼ˆæˆ– Leaderï¼‰ä¼šåšçš„ï¼š
æ­¥éª¤ è¡Œä¸º
âœ… æ‹‰å–æ‰€æœ‰äººæäº¤çš„æ¨¡åž‹ä¿®æ”¹
âœ… ç»Ÿä¸€æ‰§è¡Œï¼šdotnet ef migrations add xxx
âœ… åº”ç”¨ï¼šdotnet ef database update
âœ… æäº¤è¿ç§»æ–‡ä»¶åˆ°ä»“åº“
âœ… æŽ¨é€å˜æ›´åˆ°ä¸»åˆ†æ”¯å¹¶é€šçŸ¥æ‰€æœ‰äºº

# é¡¹ç›®åˆšè¦ä¸Šçº¿æ•°æ®åº“æ“ä½œæµç¨‹(æ­¤æ—¶å®¢æˆ·é‚£é‡Œæ²¡æœ‰æ•°æ®åº“)

æ­£å¸¸å¼€å‘è¿‡ç¨‹ä¸­å³ä½¿æ˜¯æ•°æ®åº“ç®¡ç†å‘˜ç»Ÿä¸€æ“ä½œï¼Œä¹Ÿä¼šæœ‰å¾ˆå¤šå¾ˆå¤šè¿ç§»æ–‡ä»¶çš„å¯èƒ½

1. åˆ é™¤æ•°æ®åº“

```
dotnet ef database drop
```

2. åˆ é™¤æ‰€æœ‰æ—§è¿ç§»æ–‡ä»¶
3. ç”Ÿæˆæ–°çš„è¿ç§»æ–‡ä»¶ï¼ˆå…¨é‡ï¼‰

```
dotnet ef migrations add InitialCreate
```

4. åº”ç”¨è¿ç§»ï¼Œåˆ›å»ºæ•°æ®åº“ç»“æž„
   dotnet ef database update

# å¥½å˜žï¼Œé‚£ä¸‹ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æžœå®¢æˆ·é‚£é‡Œæœ‰ä¸€ä¸ª 1.0 æ—¶å€™å‘å¸ƒçš„äº§å“äº†å‘¢ï¼Œå·²ç»æœ‰æ•°æ®åº“äº†ï¼ŒçŽ°åœ¨æˆ‘ä»¬è¦å‘å¸ƒ 2.0 çš„äº§å“ï¼Œæ•°æ®åº“æœ‰å¾ˆå¤šæ›´æ–°ï¼Œè¦æ€Žä¹ˆåŠž?

# å¯¹ï¼Œæˆ‘çš„ç–‘é—®å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å·²ç»å‘å¸ƒè¿‡ 1.0 ç‰ˆæœ¬äº†ï¼Œç„¶åŽå¼€å‘ 2.0ï¼Œè¿™æœŸé—´æ•°æ®åº“ç®¡ç†å‘˜å·²ç»åŸºäºŽ 1.0 çš„æ•°æ®åº“ ç”Ÿæˆè¿‡å¤šæ¬¡è¿ç§»æ–‡ä»¶äº†å‘€ï¼ŒåŽ»æ›´æ–°æ•°æ®åº“ã€‚æˆ‘ä»¬å¯èƒ½åšä¸€ä¸ª 1.0 æ•°æ®åº“çš„å¤‡ä»½å—ï¼Œç­‰ 2.0 å¼€å‘å®ŒæˆåŽï¼Œæˆ‘ä»¬åŸºäºŽè¿™ä¸ª 1.0 çš„åŽŸæœ¬æ•°æ®åº“å–ç»Ÿä¸€ç”Ÿæˆä¸€æ¬¡è¿ç§»æ–‡ä»¶?

ä½ æçš„è¿™ä¸ªæ€è·¯éžå¸¸å¥½ï¼Œè€Œä¸”å¾ˆå¤šæˆç†Ÿå›¢é˜Ÿä¹Ÿæ­£æ˜¯è¿™ä¹ˆå¹²çš„ï¼æˆ‘ä»¬æ¥é€æ­¥åˆ†æžå¹¶ç¡®è®¤ä¸€ä¸‹è¿™ç§åšæ³•çš„å¯è¡Œæ€§å’ŒæŽ¨èå®žè·µã€‚
ðŸ”¹3. 2.0 å¼€å‘å®ŒæˆåŽï¼ˆå‡†å¤‡ä¸Šçº¿ï¼‰
âœ… æ­¥éª¤ Bï¼šå‡†å¤‡ä¸€ä»½ v1.0 çš„æ•°æ®åº“å‰¯æœ¬
ä»Žå®¢æˆ·å¤‡ä»½æ¢å¤ä¸€ä¸ªæœ¬åœ°å‰¯æœ¬

æˆ–è€…ä¿ç•™ä¸€ä»½ 1.0 çš„æµ‹è¯•æ•°æ®åº“å¿«ç…§

âœ… æ­¥éª¤ Cï¼šé‡å»ºä¸€ä»½å…¨æ–°çš„ 2.0 è¿ç§»

```
dotnet ef migrations add UpgradeToV2
```

EF Core ä¼šæ¯”è¾ƒå½“å‰æ¨¡åž‹å’Œ v1.0 æ•°æ®åº“çš„å¿«ç…§å·®å¼‚ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä»½å®Œæ•´çš„å‡çº§è¿ç§»ã€‚

âœ… æ­¥éª¤ Dï¼šåœ¨å‰¯æœ¬æ•°æ®åº“ä¸Šæµ‹è¯•è¯¥è¿ç§»

```
dotnet ef database update
```

ç¡®ä¿è¿™ä»½è¿ç§»èƒ½é¡ºåˆ©ä»Ž 1.0 âžœ 2.0

âœ… æ­¥éª¤ Eï¼šå¯¼å‡º SQL è„šæœ¬ï¼ˆå¯äº¤ä»˜ç»™å®¢æˆ·ï¼‰

```
dotnet ef migrations script -o upgrade_v2.sql
```

# æ‰€ä»¥ 2.0 ç‰ˆæœ¬å¼€å‘ä¹‹å‰ å¤‡ä»½ 1.0 æ•°æ®åº“å¾ˆé‡è¦ï¼Œ

# å°è¯•å¤‡ä»½æˆ‘çš„ msql æ•°æ®åº“

é€»è¾‘å¤‡ä»½ï¼Œé»˜è®¤æ–¹å¼

```
docker exec -it UserApiMysql001 bash

docker exec UserApiMysql001 sh -c 'exec mysqldump -uroot -pacsdev312 beta_user' > C:\Code\2.netcore_microservice_userService\2.netcore_microservice_userservice\User.API\beta_user_backup.sql
```
