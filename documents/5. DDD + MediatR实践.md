# æ„å»ºä¸€ä¸ª DDD + MediatR + MVC çš„é¡¹ç›®ç»“æ„

C:\Code\2.netcore_microservice_userService\2.netcore_microservice_userservice\DDDPlusMediatRTest\ECommerce

âœ… ç›®æ ‡ç»“æ„ï¼ˆç®€åŒ–ç‰ˆ DDD æ¶æ„ï¼‰

```
ECommerce.sln
â”‚
â”œâ”€â”€ ECommerce.API              â†’ MVC Web é¡¹ç›® (å…¥å£)
â”œâ”€â”€ ECommerce.Application      â†’ åº”ç”¨é€»è¾‘ï¼ŒCommand/Query/Handlers
â”œâ”€â”€ ECommerce.Domain           â†’ èšåˆæ ¹ã€å®ä½“ã€æ¥å£ã€é¢†åŸŸäº‹ä»¶ç­‰
â”œâ”€â”€ ECommerce.Infrastructure   â†’ æ•°æ®åº“è®¿é—®ã€é‚®ä»¶æœåŠ¡ç­‰å®ç°

```

C:\Code\2.netcore_microservice_userService\2.netcore_microservice_userservice>cd DDDPlusMediatRTest

ğŸ§± ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè§£å†³æ–¹æ¡ˆå’Œé¡¹ç›®

```
mkdir ECommerce
cd ECommerce

# åˆ›å»ºè§£å†³æ–¹æ¡ˆ
dotnet new sln -n ECommerce

# åˆ›å»ºå„é¡¹ç›®
dotnet new mvc -n ECommerce.API
dotnet new classlib -n ECommerce.Application
dotnet new classlib -n ECommerce.Domain
dotnet new classlib -n ECommerce.Infrastructure

```

ğŸ”— ç¬¬äºŒæ­¥ï¼šæ·»åŠ é¡¹ç›®å¼•ç”¨å…³ç³»

```
# API ä¾èµ– Application
dotnet add ECommerce.API/ECommerce.API.csproj reference ECommerce.Application

# Application ä¾èµ– Domain
dotnet add ECommerce.Application/ECommerce.Application.csproj reference ECommerce.Domain

# Infrastructure ä¾èµ– Domain
dotnet add ECommerce.Infrastructure/ECommerce.Infrastructure.csproj reference ECommerce.Domain

# Application ä¾èµ– Infrastructureï¼ˆæˆ–è€…é€šè¿‡æ¥å£æ³¨å…¥ï¼‰
dotnet add ECommerce.Application/ECommerce.Application.csproj reference ECommerce.Infrastructure

```

ğŸ§© ç¬¬ä¸‰æ­¥ï¼šå®‰è£… NuGet åŒ…
åœ¨å¯¹åº”çš„é¡¹ç›®ä¸­å®‰è£…ä»¥ä¸‹å¸¸ç”¨åº“ï¼š

âœ… åœ¨ ECommerce.Applicationï¼š

```
dotnet add ECommerce.Application package MediatR.Extensions.Microsoft.DependencyInjection
dotnet add ECommerce.Application package AutoMapper.Extensions.Microsoft.DependencyInjection

```

âœ… åœ¨ ECommerce.Infrastructureï¼š

```
dotnet add ECommerce.Infrastructure package Microsoft.EntityFrameworkCore
dotnet add ECommerce.Infrastructure package Microsoft.EntityFrameworkCore.SqlServer
dotnet add ECommerce.Infrastructure package Microsoft.Extensions.DependencyInjection.Abstractions
```

âœ… åœ¨ ECommerce.APIï¼š

```
dotnet add ECommerce.API package MediatR
dotnet add ECommerce.API package AutoMapper
dotnet add ECommerce.API package Swashbuckle.AspNetCore  # å¯é€‰ï¼šSwagger æ”¯æŒ

```

MediatR åŒ…ç‰ˆæœ¬ä¸å…¼å®¹
âœ… æ‰€ä»¥ä½ éœ€è¦åœ¨ Domain å±‚ä¸­å®‰è£… MediatR åŒ…

```
dotnet add ECommerce.Domain package MediatR --version 11.1.0
dotnet add ECommerce.Application package MediatR.Extensions.Microsoft.DependencyInjection --version 11.1.0
```

# é—®é¢˜ 1

ç»è¿‡ä¸€äº›ä¿®æ”¹åï¼Œèƒ½å¤Ÿ debug ä»£ç äº†ï¼Œ
é¡¹ç›®å¼•ç”¨å…³ç³»æ˜¯ API å¼•ç”¨çš„ Application,API å¹¶æ²¡æœ‰ç›´æ¥å¼•ç”¨ Infrastructureï¼Œ
åœ¨ API çš„ Program.cs ä¸­ä»£ç 
builder.Services.AddApplication(); // å°è£…åœ¨ Application å±‚æ‰©å±•æ–¹æ³•ä¸­
è¿™ä¸ªèƒ½å¤Ÿè°ƒç”¨åˆ° Application ä¸­ï¼Œæˆ‘å¯ä»¥ç†è§£

ç„¶è€Œï¼Œ
builder.Services.AddInfrastructure(builder.Configuration); // Infrastructure æ‰©å±•
è¿™ä¸ªä»£ç å´èƒ½è°ƒç”¨åˆ° Infrastructure ä¸­ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢

## åŸå› 

1. é—´æ¥å¼•ç”¨çš„ä¼ é€’
   åœ¨ .NETï¼ˆåŒ…æ‹¬ .NET Core/.NET 5+ï¼‰é¡¹ç›®ä¸­ï¼Œé¡¹ç›®å¼•ç”¨æ˜¯å¯ä»¥ä¼ é€’çš„ã€‚
   ä¹Ÿå°±æ˜¯è¯´ï¼š

- å¦‚æœ API å¼•ç”¨äº† Application
- Application åˆå¼•ç”¨äº† Infrastructure
- é‚£ä¹ˆ API é¡¹ç›®åœ¨ç¼–è¯‘æ—¶ï¼Œå…¶å®ä¹Ÿèƒ½è®¿é—®åˆ° Infrastructure é‡Œçš„ public ç±»å‹å’Œæ–¹æ³•

éªŒè¯ï¼š
æ­¤æ—¶å¦‚æœåœ¨ Application ä¸­åˆ é™¤å¯¹ Infrastructure çš„å¼•ç”¨
<ProjectReference Include="..\ECommerce.Infrastructure\ECommerce.Infrastructure.csproj" />
build ä»£ç å°±ä¼šæŠ¥é”™äº†ï¼Œæ‰¾ä¸åˆ° AddInfrastructure

# é—®é¢˜ 2

æŠŠ <!-- <PackageReference Include="AutoMapper" Version="12.0.1" /> -->åœ¨æ‰€æœ‰å·¥ç¨‹ä¸­éƒ½æ³¨é‡Šæ‰ï¼Œä¾ç„¶èƒ½å¤Ÿ dotnet build æˆåŠŸ

## åŸå› 

ECommerce.Application.csproj é‡Œè¿˜ä¿ç•™äº†ï¼š
<PackageReference Include="AutoMapper.Extensions.Microsoft.DependencyInjection" Version="12.0.1" />
è¿™ä¸ªåŒ…ä¼šè‡ªåŠ¨ä¾èµ– AutoMapperï¼Œæ‰€ä»¥å³ä½¿ä½ æ³¨é‡Šæ‰äº† AutoMapperï¼Œdotnet build ä¾ç„¶èƒ½æˆåŠŸã€‚

# é—®é¢˜ 3

å¥½ï¼Œä¸‹ä¸€ä¸ªé—®é¢˜æ˜¯ ECommerce.Application ä¸­å»æ‰§è¡Œä¾èµ–æ³¨å…¥ï¼Œ@DependencyInjection.cs è¿™é‡Œæ‰§è¡Œäº† AddMediatR æ˜¯ä¸æ˜¯ å°±ä¼šä½¿å¾—@CreateOrderHandler.cs å…¶ä¸­çš„\_mediator ç§æœ‰å¯¹è±¡åˆå§‹åŒ–

## åŸå› ï¼š

1. AddMediatR çš„ä½œç”¨
   services.AddMediatR(typeof(CreateOrderHandler).Assembly); çš„ä½œç”¨æ˜¯ï¼š
   1. AddMediatR çš„ä½œç”¨
      services.AddMediatR(typeof(CreateOrderHandler).Assembly); çš„ä½œç”¨æ˜¯ï¼š
   - æŠŠ MediatR ç›¸å…³çš„æ‰€æœ‰ Handlerï¼ˆæ¯”å¦‚ CreateOrderHandlerï¼‰è‡ªåŠ¨æ³¨å†Œåˆ°ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰å®¹å™¨ä¸­ã€‚
   - æŠŠ IMediator è¿™ä¸ªæ¥å£çš„å®ç°ï¼ˆé€šå¸¸æ˜¯ Mediator ç±»ï¼‰æ³¨å†Œä¸ºæœåŠ¡ã€‚
2. \_mediator æ˜¯æ€ä¹ˆè¢«åˆå§‹åŒ–çš„ï¼Ÿ

   - å½“ä½ åœ¨ CreateOrderHandler çš„æ„é€ å‡½æ•°é‡Œå†™äº† IMediator mediator å‚æ•°æ—¶ï¼Œåªè¦è¿™ä¸ª Handler æ˜¯é€šè¿‡ä¾èµ–æ³¨å…¥å®¹å™¨åˆ›å»ºçš„ï¼ŒDI å®¹å™¨ä¼šè‡ªåŠ¨æŠŠ IMediator çš„å®ç°æ³¨å…¥è¿›æ¥ã€‚
   - è¿™ä¸ªæ³¨å…¥çš„å‰æï¼Œå°±æ˜¯ä½ å·²ç»é€šè¿‡ AddMediatR æŠŠ IMediator æ³¨å†Œåˆ°å®¹å™¨é‡Œäº†ã€‚

   ### æµç¨‹æ€»ç»“

   ä½ åœ¨ Program.cs é‡Œè°ƒç”¨äº† AddApplication()ï¼Œé—´æ¥æ‰§è¡Œäº† AddMediatR(...)ã€‚
   è¿™æ ·ï¼ŒIMediator åŠæ‰€æœ‰ Handler éƒ½è¢«æ³¨å†Œåˆ° DI å®¹å™¨ã€‚
   å½“æœ‰åœ°æ–¹éœ€è¦ CreateOrderHandlerï¼ˆæ¯”å¦‚ MediatR æ¡†æ¶å†…éƒ¨ï¼Œæˆ–è€…ä½ æ‰‹åŠ¨ä»å®¹å™¨è·å–ï¼‰ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨ new ä¸€ä¸ª CreateOrderHandlerï¼Œå¹¶æŠŠ IMediatorã€IOrderRepositoryã€IMapper ç­‰ä¾èµ–éƒ½æ³¨å…¥è¿›å»ã€‚
   æ‰€ä»¥ï¼Œ\_mediator å­—æ®µä¼šè¢«è‡ªåŠ¨åˆå§‹åŒ–

# é—®é¢˜ 4

å¤šä¸ªç¨‹åºé›†æœ‰ Handler çš„æƒ…å†µ

å¦‚æœä½ çš„ Handler åˆ†å¸ƒåœ¨å¤šä¸ªç¨‹åºé›†ï¼ˆæ¯”å¦‚ ECommerce.Application å’Œ ECommerce.APIï¼‰ï¼Œä½ ç¡®å®éœ€è¦æŠŠæ‰€æœ‰å«æœ‰ Handler çš„ç¨‹åºé›†éƒ½ä¼ ç»™ AddMediatRã€‚
å®˜æ–¹æ¨èçš„å†™æ³•æ˜¯å¯ä»¥ä¸€æ¬¡æ€§ä¼ å¤šä¸ª Assembly

1. MediatR çš„ Handler æ‰«ææœºåˆ¶

- services.AddMediatR(typeof(SomeType).Assembly) çš„æœ¬è´¨æ˜¯ï¼šæ‰«æä½ æŒ‡å®šçš„ç¨‹åºé›†ï¼ŒæŠŠæ‰€æœ‰ Handler æ³¨å†Œåˆ° DI å®¹å™¨ã€‚
- åªä¼šæ‰«æä½ æŒ‡å®šçš„é‚£ä¸ªç¨‹åºé›†ï¼ˆAssemblyï¼‰ï¼Œä¸ä¼šè‡ªåŠ¨é€’å½’æ‰«ææ‰€æœ‰å¼•ç”¨çš„ç¨‹åºé›†ã€‚

2. å¤šä¸ªç¨‹åºé›†æœ‰ Handler çš„æƒ…å†µ

- å¦‚æœä½ çš„ Handler åˆ†å¸ƒåœ¨å¤šä¸ªç¨‹åºé›†ï¼ˆæ¯”å¦‚ ECommerce.Application å’Œ ECommerce.APIï¼‰ï¼Œä½ ç¡®å®éœ€è¦æŠŠæ‰€æœ‰å«æœ‰ Handler çš„ç¨‹åºé›†éƒ½ä¼ ç»™ AddMediatRã€‚
- å®˜æ–¹æ¨èçš„å†™æ³•æ˜¯å¯ä»¥ä¸€æ¬¡æ€§ä¼ å¤šä¸ª Assembly

è¿™æ · MediatR ä¼šæ‰«ææ‰€æœ‰ä½ æŒ‡å®šçš„ç¨‹åºé›†ï¼ŒæŠŠ Handler éƒ½æ³¨å†Œè¿›å»

# é—®é¢˜ 5

ä¸»è¦æ˜¯ å’Œå®ç°äº† MediatR Handler æ¥å£çš„ç±»çš„ï¼Œæ‰ä¼šè‡ªåŠ¨æ³¨å†Œåˆ° DI å®¹å™¨å“ˆ

## è§£é‡Š

å®Œå…¨æ­£ç¡®ï¼
åªæœ‰å®ç°äº† MediatR Handler æ¥å£çš„ç±»ï¼Œæ‰ä¼šè¢« AddMediatR è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œåˆ° DI å®¹å™¨ã€‚
å…·ä½“æ¥è¯´
æ¯”å¦‚ä¸‹é¢è¿™äº›æ¥å£çš„å®ç°ç±»ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨æ³¨å†Œï¼š

- IRequestHandler<TRequest, TResponse>
- IRequestHandler<TRequest>
- INotificationHandler<TNotification>
- ä»¥åŠ MediatR çš„å…¶ä»– Handler æ¥å£
  åªæœ‰å®ç°äº†è¿™äº›æ¥å£çš„ç±»ï¼Œæ‰ä¼šè¢« MediatR è¯†åˆ«ä¸º Handlerï¼Œè‡ªåŠ¨æ³¨å†Œåˆ° DI å®¹å™¨ã€‚

# é—®é¢˜ 6

å¥½æ»´ï¼Œç„¶åå›åˆ°æˆ‘ä¹‹å‰çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆ Controller é‡Œçš„ MediatR èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¹Ÿæ˜¯å› ä¸º AddMedia æ–¹æ³•æŠŠ IMediator æ³¨å†Œåˆ° DI é‡Œé¢äº†ï¼Œ

## è§£é‡Š

å®Œå…¨æ­£ç¡®ï¼ä½ çš„ç†è§£éå¸¸åˆ°ä½ï¼
è¯¦ç»†è§£é‡Š

- ä½ åœ¨ Program.cs æˆ– Startup.cs é‡Œè°ƒç”¨äº† services.AddMediatR(...)ã€‚
- è¿™ä¸€æ­¥ä¸ä»…æ³¨å†Œäº†æ‰€æœ‰ Handlerï¼Œè¿˜ä¼šæŠŠ IMediator åŠå…¶ç›¸å…³å®ç°æ³¨å†Œåˆ° DI å®¹å™¨ã€‚
- è¿™æ ·ï¼Œä»»ä½•è¢« DI å®¹å™¨åˆ›å»ºçš„ç±»ï¼ˆåŒ…æ‹¬ Controllerã€Serviceã€Handler ç­‰ï¼‰ï¼Œéƒ½å¯ä»¥é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ IMediatorã€‚

# é—®é¢˜ 7

æˆ‘çš„å…³é”®ç‚¹ï¼Œæ˜¯ä¸Šä¸‹æ–‡ï¼Œæˆ‘è™½ç„¶æ˜¯ Application ä¸­æ‰§è¡Œçš„ï¼Œå…¶å®ä¹Ÿæ˜¯ API é‡Œå»è°ƒç”¨çš„ï¼Œæ­¤æ—¶ Domain é‡ŒæŠ€æœ¯ä¸Šä¹Ÿèƒ½åº”ç”¨ï¼Œæˆ‘æœ‰ç‚¹ç†è§£ä¸ä¸Šå»

## è§£é‡Š

è¿™å…¶å®æ¶‰åŠåˆ°â€œä¾èµ–æ³¨å…¥çš„ä¸Šä¸‹æ–‡â€å’Œâ€œå¯¹è±¡çš„åˆ›å»ºæ—¶æœºâ€è¿™ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜

1. DI å®¹å™¨çš„â€œä¸Šä¸‹æ–‡â€æ˜¯ä»€ä¹ˆï¼Ÿ

- DI å®¹å™¨å…¶å®å°±æ˜¯ä¸€ä¸ªâ€œå…¨å±€å·¥å‚â€ï¼Œå®ƒè´Ÿè´£åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…ï¼Œå¸®ä½  new å„ç§å¯¹è±¡ï¼Œå¹¶è‡ªåŠ¨æŠŠä¾èµ–æ³¨å…¥è¿›å»ã€‚
- åªè¦ä½ åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ˆæ¯”å¦‚ API é¡¹ç›®çš„ Program.csï¼‰æ³¨å†Œäº†æœåŠ¡ï¼Œæ•´ä¸ªåº”ç”¨çš„æ‰€æœ‰å±‚ï¼ˆAPIã€Applicationã€Infrastructureã€Domainï¼‰éƒ½èƒ½ç”¨è¿™äº›æœåŠ¡ï¼Œå‰ææ˜¯è¿™äº›å¯¹è±¡æ˜¯é€šè¿‡ DI å®¹å™¨åˆ›å»ºçš„

2. â€œè°æ¥ newâ€å†³å®šäº†èƒ½ä¸èƒ½æ³¨å…¥

- åªæœ‰é€šè¿‡ DI å®¹å™¨ new çš„å¯¹è±¡ï¼Œæ‰èƒ½è‡ªåŠ¨æ³¨å…¥ä¾èµ–ã€‚
- æ¯”å¦‚ Controllerã€Handlerã€Serviceï¼Œéƒ½æ˜¯ç”± DI å®¹å™¨ new çš„ï¼Œæ‰€ä»¥å¯ä»¥æ³¨å…¥ IMediatorã€‚
- ä½†å¦‚æœä½ åœ¨ä»£ç é‡Œæ‰‹åŠ¨ new Order()ï¼Œé‚£ Order é‡Œçš„ä¾èµ–æ˜¯ä¸ä¼šè¢«æ³¨å…¥çš„ã€‚

3. â€œä¸Šä¸‹æ–‡â€ä¸¾ä¾‹è¯´æ˜

   åœºæ™¯ä¸€ï¼šAPI è°ƒç”¨ Application

- ä½ åœ¨ API çš„ Controller é‡Œæ³¨å…¥äº† IMediatorï¼Œè°ƒç”¨äº† Application å±‚çš„ Handlerã€‚
- Handler ä¹Ÿæ˜¯é€šè¿‡ DI å®¹å™¨ new çš„ï¼Œæ‰€ä»¥ä¾èµ–éƒ½èƒ½æ³¨å…¥ã€‚

  åœºæ™¯äºŒï¼šApplication/Handler è°ƒç”¨ Domain

- Handler é‡Œ new äº†ä¸€ä¸ª Domain å¯¹è±¡ï¼ˆæ¯”å¦‚ Orderï¼‰ï¼Œå¦‚æœæ˜¯æ‰‹åŠ¨ new çš„ï¼Œé‚£ Order é‡Œçš„ä¾èµ–ä¸ä¼šè¢«æ³¨å…¥ã€‚
- åªæœ‰ä½ æŠŠ Domain å¯¹è±¡ä¹Ÿæ³¨å†Œåˆ° DI å®¹å™¨ï¼Œå¹¶é€šè¿‡å®¹å™¨ newï¼Œä¾èµ–æ‰ä¼šè¢«æ³¨å…¥ã€‚
