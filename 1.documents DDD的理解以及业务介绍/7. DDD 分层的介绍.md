# DDD 分层介绍

![alt text](<../0.截图/0.DDD 分层 .png>)

# DDD 中有四层，用户界面层，应用层，领域层，基础设施层，我想知道调用关系，都是谁调用谁，引用了谁

# 🏗️ DDD 四层架构的调用关系

总体调用方向：

用户界面层 → 应用层 → 领域层 ← 基础设施层

# 🔍 详细调用关系图

```
用户界面层 (Presentation Layer)
        ↓
应用层 (Application Layer)
        ↓
领域层 (Domain Layer)
        ↑
基础设施层 (Infrastructure Layer)
```

1. 用户界面层 (Presentation Layer)

## 职责：

- 接收用户请求（HTTP API、Web 页面、CLI 等）

- 验证输入数据格式

- 调用应用层服务

- 返回响应结果

## 调用关系：

```
// Controllers/OrderController.cs
[ApiController]
public class OrderController : ControllerBase
{
    private readonly IOrderService _orderService; // ← 依赖应用层

    [HttpPost]
    public async Task<IActionResult> CreateOrder(CreateOrderRequest request)
    {
        // 1. 输入验证（格式验证）
        if (!ModelState.IsValid) return BadRequest();

        // 2. 调用应用层服务 ← 调用应用层
        var command = new CreateOrderCommand(...);
        var orderId = await _orderService.CreateOrderAsync(command);

        // 3. 返回响应
        return Ok(new { OrderId = orderId });
    }
}
```

## 引用关系：

```
<!-- 用户界面层项目文件 -->
<ProjectReference Include="..\Application\Application.csproj" />
<!-- 通常不直接引用领域层和基础设施层 -->
```

2. 应用层 (Application Layer)

## 职责：

- 协调领域对象完成用例

- 事务管理

- 安全验证

- 调用基础设施层

## 调用关系：

```
// Application/Services/OrderService.cs
public class OrderService
{
    private readonly IOrderRepository _orderRepository; // ← 依赖基础设施层接口
    private readonly IEmailService _emailService;      // ← 依赖基础设施层接口

    public async Task<OrderId> CreateOrderAsync(CreateOrderCommand command)
    {
        // 1. 使用领域层创建聚合根 ← 调用领域层
        var order = Order.Create(command.CustomerId, command.ShippingAddress, command.Items);

        // 2. 调用基础设施层保存数据 ← 调用基础设施层
        await _orderRepository.AddAsync(order);
        await _orderRepository.SaveChangesAsync();

        // 3. 调用基础设施层发送通知 ← 调用基础设施层
        await _emailService.SendOrderConfirmation(order.Id);

        return order.Id;
    }
}
```

## 引用关系：

```
<!-- 应用层项目文件 -->
<ProjectReference Include="..\Domain\Domain.csproj" />
<!-- 引用领域层，不直接引用基础设施层实现 -->
```

3. 领域层 (Domain Layer)

## 职责：

- 核心业务逻辑

- 领域模型（实体、值对象、聚合根）

- 领域服务

- 领域事件

- 业务规则

## 调用关系：

```
// Domain/Orders/Order.cs
public class Order : Entity, IAggregateRoot
{
    // 领域层内部调用，不依赖其他层
    public void ChangeShippingAddress(Address newAddress)
    {
        // 纯业务逻辑
        if (Status == OrderStatus.Shipped)
            throw new InvalidOperationException("已发货的订单不能修改地址");

        var oldAddress = ShippingAddress;
        ShippingAddress = newAddress;

        // 发布领域事件（领域层内部）
        AddDomainEvent(new ShippingAddressChangedEvent(Id, oldAddress, newAddress));
    }

    // 领域层可以定义接口，供基础设施层实现
    // 但不直接调用基础设施层
}
```

## 引用关系：

```
<!-- 领域层项目文件 -->
<!-- 不引用任何其他层！保持纯净 -->
<!-- 可能引用一些通用的NuGet包，如MediatR用于领域事件 -->
```

4. 基础设施层 (Infrastructure Layer)

## 职责：

- 数据持久化（数据库、文件系统）

- 外部服务调用（邮件、消息队列、第三方 API）

- 实现应用层定义的接口

## 调用关系：

```
// Infrastructure/Repositories/OrderRepository.cs
public class OrderRepository : IOrderRepository // ← 实现应用层/领域层定义的接口
{
    private readonly ApplicationDbContext _context;

    public async Task<Order?> GetByIdAsync(OrderId id)
    {
        // 调用EF Core（基础设施层内部）
        var order = await _context.Orders
            .Include(o => o.OrderItems)
            .FirstOrDefaultAsync(o => o.Id == id);

        return order; // ← 返回领域对象
    }
}

// Infrastructure/Services/EmailService.cs
public class EmailService : IEmailService // ← 实现应用层定义的接口
{
    private readonly ISmtpClient _smtpClient;

    public async Task SendOrderConfirmation(OrderId orderId)
    {
        // 调用外部邮件服务
        await _smtpClient.SendAsync(...);
    }
}
```

## 引用关系：

```
<!-- 基础设施层项目文件 -->
<ProjectReference Include="..\Domain\Domain.csproj" />
<ProjectReference Include="..\Application\Application.csproj" />
<!-- 引用领域层和应用层 -->
<!-- 引用各种技术NuGet包：EntityFrameworkCore、Redis、RabbitMQ等 -->
```

# 疑问

## 基础设施层需要引用 应用层吗

很好的问题！答案取决于你的具体设计，但通常来说：基础设施层不需要引用应用层。

## 对如果我们约定好，接口只能定义在 领域层，那我觉得 基础设施层，就不需要引用应用层了

完全正确！ 你的理解非常准确。这正是 DDD 架构的最佳实践。

## 我正在学习.net DDD 领域驱动设计的开发 Presentation → Application + Infrastructure ，展示层会依赖 基础设施层吗

这是一个很好的 DDD 架构问题。在标准的 DDD 分层架构中，展示层不应该直接依赖基础设施层。

## 正确的依赖关系:

```
展示层 (Presentation)
↓
应用层 (Application)
↓
领域层 (Domain)
↑
基础设施层 (Infrastructure)
```

## 依赖方向说明

1. 展示层 → 应用层 ✅

- 调用应用服务执行用例

- 传递 DTO，处理用户交互

2. 应用层 → 领域层 ✅

- 协调领域对象完成业务逻辑

- 实现用例流程

3. 基础设施层 → 领域层 ✅（通过依赖倒置）

- 实现领域层定义的接口（如仓储接口）

- 提供技术实现（数据库、消息队列等）
