# DDD åˆ†å±‚ä»‹ç»

![alt text](<../0.æˆªå›¾/0.DDD åˆ†å±‚ .png>)

# DDD ä¸­æœ‰å››å±‚ï¼Œç”¨æˆ·ç•Œé¢å±‚ï¼Œåº”ç”¨å±‚ï¼Œé¢†åŸŸå±‚ï¼ŒåŸºç¡€è®¾æ–½å±‚ï¼Œæˆ‘æƒ³çŸ¥é“è°ƒç”¨å…³ç³»ï¼Œéƒ½æ˜¯è°è°ƒç”¨è°ï¼Œå¼•ç”¨äº†è°

# ğŸ—ï¸ DDD å››å±‚æ¶æ„çš„è°ƒç”¨å…³ç³»

æ€»ä½“è°ƒç”¨æ–¹å‘ï¼š

ç”¨æˆ·ç•Œé¢å±‚ â†’ åº”ç”¨å±‚ â†’ é¢†åŸŸå±‚ â† åŸºç¡€è®¾æ–½å±‚

# ğŸ” è¯¦ç»†è°ƒç”¨å…³ç³»å›¾

```
ç”¨æˆ·ç•Œé¢å±‚ (Presentation Layer)
        â†“
åº”ç”¨å±‚ (Application Layer)
        â†“
é¢†åŸŸå±‚ (Domain Layer)
        â†‘
åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)
```

1. ç”¨æˆ·ç•Œé¢å±‚ (Presentation Layer)

## èŒè´£ï¼š

- æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼ˆHTTP APIã€Web é¡µé¢ã€CLI ç­‰ï¼‰

- éªŒè¯è¾“å…¥æ•°æ®æ ¼å¼

- è°ƒç”¨åº”ç”¨å±‚æœåŠ¡

- è¿”å›å“åº”ç»“æœ

## è°ƒç”¨å…³ç³»ï¼š

```
// Controllers/OrderController.cs
[ApiController]
public class OrderController : ControllerBase
{
    private readonly IOrderService _orderService; // â† ä¾èµ–åº”ç”¨å±‚

    [HttpPost]
    public async Task<IActionResult> CreateOrder(CreateOrderRequest request)
    {
        // 1. è¾“å…¥éªŒè¯ï¼ˆæ ¼å¼éªŒè¯ï¼‰
        if (!ModelState.IsValid) return BadRequest();

        // 2. è°ƒç”¨åº”ç”¨å±‚æœåŠ¡ â† è°ƒç”¨åº”ç”¨å±‚
        var command = new CreateOrderCommand(...);
        var orderId = await _orderService.CreateOrderAsync(command);

        // 3. è¿”å›å“åº”
        return Ok(new { OrderId = orderId });
    }
}
```

## å¼•ç”¨å…³ç³»ï¼š

```
<!-- ç”¨æˆ·ç•Œé¢å±‚é¡¹ç›®æ–‡ä»¶ -->
<ProjectReference Include="..\Application\Application.csproj" />
<!-- é€šå¸¸ä¸ç›´æ¥å¼•ç”¨é¢†åŸŸå±‚å’ŒåŸºç¡€è®¾æ–½å±‚ -->
```

2. åº”ç”¨å±‚ (Application Layer)

## èŒè´£ï¼š

- åè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆç”¨ä¾‹

- äº‹åŠ¡ç®¡ç†

- å®‰å…¨éªŒè¯

- è°ƒç”¨åŸºç¡€è®¾æ–½å±‚

## è°ƒç”¨å…³ç³»ï¼š

```
// Application/Services/OrderService.cs
public class OrderService
{
    private readonly IOrderRepository _orderRepository; // â† ä¾èµ–åŸºç¡€è®¾æ–½å±‚æ¥å£
    private readonly IEmailService _emailService;      // â† ä¾èµ–åŸºç¡€è®¾æ–½å±‚æ¥å£

    public async Task<OrderId> CreateOrderAsync(CreateOrderCommand command)
    {
        // 1. ä½¿ç”¨é¢†åŸŸå±‚åˆ›å»ºèšåˆæ ¹ â† è°ƒç”¨é¢†åŸŸå±‚
        var order = Order.Create(command.CustomerId, command.ShippingAddress, command.Items);

        // 2. è°ƒç”¨åŸºç¡€è®¾æ–½å±‚ä¿å­˜æ•°æ® â† è°ƒç”¨åŸºç¡€è®¾æ–½å±‚
        await _orderRepository.AddAsync(order);
        await _orderRepository.SaveChangesAsync();

        // 3. è°ƒç”¨åŸºç¡€è®¾æ–½å±‚å‘é€é€šçŸ¥ â† è°ƒç”¨åŸºç¡€è®¾æ–½å±‚
        await _emailService.SendOrderConfirmation(order.Id);

        return order.Id;
    }
}
```

## å¼•ç”¨å…³ç³»ï¼š

```
<!-- åº”ç”¨å±‚é¡¹ç›®æ–‡ä»¶ -->
<ProjectReference Include="..\Domain\Domain.csproj" />
<!-- å¼•ç”¨é¢†åŸŸå±‚ï¼Œä¸ç›´æ¥å¼•ç”¨åŸºç¡€è®¾æ–½å±‚å®ç° -->
```

3. é¢†åŸŸå±‚ (Domain Layer)

## èŒè´£ï¼š

- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

- é¢†åŸŸæ¨¡å‹ï¼ˆå®ä½“ã€å€¼å¯¹è±¡ã€èšåˆæ ¹ï¼‰

- é¢†åŸŸæœåŠ¡

- é¢†åŸŸäº‹ä»¶

- ä¸šåŠ¡è§„åˆ™

## è°ƒç”¨å…³ç³»ï¼š

```
// Domain/Orders/Order.cs
public class Order : Entity, IAggregateRoot
{
    // é¢†åŸŸå±‚å†…éƒ¨è°ƒç”¨ï¼Œä¸ä¾èµ–å…¶ä»–å±‚
    public void ChangeShippingAddress(Address newAddress)
    {
        // çº¯ä¸šåŠ¡é€»è¾‘
        if (Status == OrderStatus.Shipped)
            throw new InvalidOperationException("å·²å‘è´§çš„è®¢å•ä¸èƒ½ä¿®æ”¹åœ°å€");

        var oldAddress = ShippingAddress;
        ShippingAddress = newAddress;

        // å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼ˆé¢†åŸŸå±‚å†…éƒ¨ï¼‰
        AddDomainEvent(new ShippingAddressChangedEvent(Id, oldAddress, newAddress));
    }

    // é¢†åŸŸå±‚å¯ä»¥å®šä¹‰æ¥å£ï¼Œä¾›åŸºç¡€è®¾æ–½å±‚å®ç°
    // ä½†ä¸ç›´æ¥è°ƒç”¨åŸºç¡€è®¾æ–½å±‚
}
```

## å¼•ç”¨å…³ç³»ï¼š

```
<!-- é¢†åŸŸå±‚é¡¹ç›®æ–‡ä»¶ -->
<!-- ä¸å¼•ç”¨ä»»ä½•å…¶ä»–å±‚ï¼ä¿æŒçº¯å‡€ -->
<!-- å¯èƒ½å¼•ç”¨ä¸€äº›é€šç”¨çš„NuGetåŒ…ï¼Œå¦‚MediatRç”¨äºé¢†åŸŸäº‹ä»¶ -->
```

4. åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)

## èŒè´£ï¼š

- æ•°æ®æŒä¹…åŒ–ï¼ˆæ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿï¼‰

- å¤–éƒ¨æœåŠ¡è°ƒç”¨ï¼ˆé‚®ä»¶ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ç¬¬ä¸‰æ–¹ APIï¼‰

- å®ç°åº”ç”¨å±‚å®šä¹‰çš„æ¥å£

## è°ƒç”¨å…³ç³»ï¼š

```
// Infrastructure/Repositories/OrderRepository.cs
public class OrderRepository : IOrderRepository // â† å®ç°åº”ç”¨å±‚/é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£
{
    private readonly ApplicationDbContext _context;

    public async Task<Order?> GetByIdAsync(OrderId id)
    {
        // è°ƒç”¨EF Coreï¼ˆåŸºç¡€è®¾æ–½å±‚å†…éƒ¨ï¼‰
        var order = await _context.Orders
            .Include(o => o.OrderItems)
            .FirstOrDefaultAsync(o => o.Id == id);

        return order; // â† è¿”å›é¢†åŸŸå¯¹è±¡
    }
}

// Infrastructure/Services/EmailService.cs
public class EmailService : IEmailService // â† å®ç°åº”ç”¨å±‚å®šä¹‰çš„æ¥å£
{
    private readonly ISmtpClient _smtpClient;

    public async Task SendOrderConfirmation(OrderId orderId)
    {
        // è°ƒç”¨å¤–éƒ¨é‚®ä»¶æœåŠ¡
        await _smtpClient.SendAsync(...);
    }
}
```

## å¼•ç”¨å…³ç³»ï¼š

```
<!-- åŸºç¡€è®¾æ–½å±‚é¡¹ç›®æ–‡ä»¶ -->
<ProjectReference Include="..\Domain\Domain.csproj" />
<ProjectReference Include="..\Application\Application.csproj" />
<!-- å¼•ç”¨é¢†åŸŸå±‚å’Œåº”ç”¨å±‚ -->
<!-- å¼•ç”¨å„ç§æŠ€æœ¯NuGetåŒ…ï¼šEntityFrameworkCoreã€Redisã€RabbitMQç­‰ -->
```

# ç–‘é—®

## åŸºç¡€è®¾æ–½å±‚éœ€è¦å¼•ç”¨ åº”ç”¨å±‚å—

å¾ˆå¥½çš„é—®é¢˜ï¼ç­”æ¡ˆå–å†³äºä½ çš„å…·ä½“è®¾è®¡ï¼Œä½†é€šå¸¸æ¥è¯´ï¼šåŸºç¡€è®¾æ–½å±‚ä¸éœ€è¦å¼•ç”¨åº”ç”¨å±‚ã€‚

## å¯¹å¦‚æœæˆ‘ä»¬çº¦å®šå¥½ï¼Œæ¥å£åªèƒ½å®šä¹‰åœ¨ é¢†åŸŸå±‚ï¼Œé‚£æˆ‘è§‰å¾— åŸºç¡€è®¾æ–½å±‚ï¼Œå°±ä¸éœ€è¦å¼•ç”¨åº”ç”¨å±‚äº†

å®Œå…¨æ­£ç¡®ï¼ ä½ çš„ç†è§£éå¸¸å‡†ç¡®ã€‚è¿™æ­£æ˜¯ DDD æ¶æ„çš„æœ€ä½³å®è·µã€‚

## æˆ‘æ­£åœ¨å­¦ä¹ .net DDD é¢†åŸŸé©±åŠ¨è®¾è®¡çš„å¼€å‘ Presentation â†’ Application + Infrastructure ï¼Œå±•ç¤ºå±‚ä¼šä¾èµ– åŸºç¡€è®¾æ–½å±‚å—

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ DDD æ¶æ„é—®é¢˜ã€‚åœ¨æ ‡å‡†çš„ DDD åˆ†å±‚æ¶æ„ä¸­ï¼Œå±•ç¤ºå±‚ä¸åº”è¯¥ç›´æ¥ä¾èµ–åŸºç¡€è®¾æ–½å±‚ã€‚

## æ­£ç¡®çš„ä¾èµ–å…³ç³»:

```
å±•ç¤ºå±‚ (Presentation)
â†“
åº”ç”¨å±‚ (Application)
â†“
é¢†åŸŸå±‚ (Domain)
â†‘
åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
```

## ä¾èµ–æ–¹å‘è¯´æ˜

1. å±•ç¤ºå±‚ â†’ åº”ç”¨å±‚ âœ…

- è°ƒç”¨åº”ç”¨æœåŠ¡æ‰§è¡Œç”¨ä¾‹

- ä¼ é€’ DTOï¼Œå¤„ç†ç”¨æˆ·äº¤äº’

2. åº”ç”¨å±‚ â†’ é¢†åŸŸå±‚ âœ…

- åè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆä¸šåŠ¡é€»è¾‘

- å®ç°ç”¨ä¾‹æµç¨‹

3. åŸºç¡€è®¾æ–½å±‚ â†’ é¢†åŸŸå±‚ âœ…ï¼ˆé€šè¿‡ä¾èµ–å€’ç½®ï¼‰

- å®ç°é¢†åŸŸå±‚å®šä¹‰çš„æ¥å£ï¼ˆå¦‚ä»“å‚¨æ¥å£ï¼‰

- æä¾›æŠ€æœ¯å®ç°ï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰
