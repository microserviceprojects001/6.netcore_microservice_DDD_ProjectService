# 初始化

dotnet new webapi -n Project.API --use-controllers --force
dotnet new classlib -n Project.Domain
dotnet new classlib -n Project.Infrastructure

# 将项目添加到解决方案

dotnet sln add Project/Project.API/Project.API.csproj
dotnet sln add Project/Project.Domain/Project.Domain.csproj
dotnet sln add Project/Project.Infrastructure/Project.Infrastructure.csproj

# 设置项目引用关系

通常的依赖关系是：

API → Infrastructure → Domain

```
# Infrastructure 引用 Domain
dotnet add Project.Infrastructure/Project.Infrastructure.csproj reference Project.Domain/Project.Domain.csproj

# API 引用 Infrastructure
dotnet add Project.API/Project.API.csproj reference Project.Infrastructure/Project.Infrastructure.csproj

# API 也可以直接引用 Domain（根据你的架构设计）
dotnet add Project.API/Project.API.csproj reference Project.Domain/Project.Domain.csproj
```

# 添加 nuget 包

dotnet add Project.Domain package MediatR --version 11.1.0

dotnet add Project.API package MediatR --version 11.1.0
dotnet add Project.API package MediatR.Extensions.Microsoft.DependencyInjection --version 11.1.0
dotnet add Project.API package Microsoft.EntityFrameworkCore.Design --version 8.0.0

dotnet add Project.Infrastructure package MediatR --version 11.1.0

# 有一个考虑

服务发现的功能可以写成 nuget 包
D:\Code\1.microservice\2.netcore_microservice_userService\Project\Project.API\Dtos\ServerDiscoveryConfig.cs

# 初始化数据库遇到的问题

dotnet ef migrations add initProjectDb

在 Project.API 中代码如下：

```
var connectionString = builder.Configuration.GetConnectionString("MySQLProject");
Console.WriteLine($"DB Server: {connectionString}");

builder.Services.AddDbContext<ProjectContext>(options =>
    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString))
);
```

执行数据库初始化时候报错

```
No DbContext was found in assembly 'Project.API'. Ensure that you're using the correct assembly and that the typt the type is neither abstract nor generic.
```

# 原因

这个错误是因为 dotnet ef migrations 命令默认在当前程序集（Project.API）中查找 DbContext，但您的
ProjectContext
在
Project.Infrastructure
程序集中。

# 方案(不 work)

```
dotnet ef migrations add initProjectDb --project Project.Infrastructure --startup-project Project.API
```

# 遇到问题

嗯，我现在是在 Project.API 中执行了

dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure --context ProjectContext

这个命令，现在报错 Unable to create a 'DbContext' of type 'ProjectContext'. The exception 'Unable to resolve service for type
'Microsoft.EntityFrameworkCore.DbContextOptions`1[Project.Infrastructure.ProjectContext]' while attempting
to activate 'Project.Infrastructure.ProjectContext'.' was thrown while attempting to create an instance. For the different patterns supported at design time, see https://go.microsoft.com/fwlink/?linkid=851728

# 经过添加 ProjectContextDesignTimeFactory 后执行以下命令，能成功的更新本地数据库了

```
D:\Code\1.microservice\2.netcore_microservice_userService\Project\Project.API

Server=localhost;port=3307;Database=beta_project;User=abel;Password=acsdev312!@;

dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure
dotnet ef database update --startup-project . --project ../Project.Infrastructure

```

此时如果 我把数据库连接直接换成 阿里云服务器的数据库连接，然后执行以上的 update 命令，是可以更新数据库的
Server=8.140.59.193;port=3307;Database=beta_project;User=abel;Password=acsdev312!@;
