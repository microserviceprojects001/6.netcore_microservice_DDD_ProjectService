# åˆå§‹åŒ–æ•°æ®åº“é‡åˆ°çš„é—®é¢˜

dotnet ef migrations add initProjectDb

åœ¨ Project.API ä¸­ä»£ç å¦‚ä¸‹ï¼š

```
var connectionString = builder.Configuration.GetConnectionString("MySQLProject");
Console.WriteLine($"DB Server: {connectionString}");

builder.Services.AddDbContext<ProjectContext>(options =>
    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString))
);
```

æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–æ—¶å€™æŠ¥é”™

```
No DbContext was found in assembly 'Project.API'. Ensure that you're using the correct assembly and that the typt the type is neither abstract nor generic.
```

# åŸå› 

è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸º dotnet ef migrations å‘½ä»¤é»˜è®¤åœ¨å½“å‰ç¨‹åºé›†ï¼ˆProject.APIï¼‰ä¸­æŸ¥æ‰¾ DbContextï¼Œä½†æ‚¨çš„
ProjectContext
åœ¨
Project.Infrastructure
ç¨‹åºé›†ä¸­ã€‚

# æ–¹æ¡ˆ(ä¸ work)

```
dotnet ef migrations add initProjectDb --project Project.Infrastructure --startup-project Project.API
```

# é‡åˆ°é—®é¢˜

å—¯ï¼Œæˆ‘ç°åœ¨æ˜¯åœ¨ Project.API ä¸­æ‰§è¡Œäº†

dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure --context ProjectContext

è¿™ä¸ªå‘½ä»¤ï¼Œç°åœ¨æŠ¥é”™ Unable to create a 'DbContext' of type 'ProjectContext'. The exception 'Unable to resolve service for type
'Microsoft.EntityFrameworkCore.DbContextOptions`1[Project.Infrastructure.ProjectContext]' while attempting
to activate 'Project.Infrastructure.ProjectContext'.' was thrown while attempting to create an instance. For the different patterns supported at design time, see https://go.microsoft.com/fwlink/?linkid=851728

# ç»è¿‡æ·»åŠ  ProjectContextDesignTimeFactory åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œèƒ½æˆåŠŸçš„æ›´æ–°æœ¬åœ°æ•°æ®åº“äº†

```
D:\Code\1.microservice\2.netcore_microservice_userService\Project\Project.API

Server=localhost;port=3307;Database=beta_project;User=abel;Password=acsdev312!@;

dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure
dotnet ef database update --startup-project . --project ../Project.Infrastructure

```

æ­¤æ—¶å¦‚æœ æˆ‘æŠŠæ•°æ®åº“è¿æ¥ç›´æ¥æ¢æˆ é˜¿é‡Œäº‘æœåŠ¡å™¨çš„æ•°æ®åº“è¿æ¥ï¼Œç„¶åæ‰§è¡Œä»¥ä¸Šçš„ update å‘½ä»¤ï¼Œæ˜¯å¯ä»¥æ›´æ–°æ•°æ®åº“çš„
Server=8.140.59.193;port=3307;Database=beta_project;User=abel;Password=acsdev312!@;

# è§£é‡Šä¸€ä¸‹ EF Core æ•°æ®åº“ç”Ÿæˆçš„å·¥ä½œåŸç†å’Œå¿…è¦æ¡ä»¶

1. æ ¸å¿ƒå¿…è¦æ¡ä»¶
   æ•°æ®åº“ç”ŸæˆçœŸæ­£éœ€è¦çš„æ˜¯ï¼š

âœ… DbContext ç±»

âœ… æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²

âœ… æ•°æ®åº“æä¾›ç¨‹åºé…ç½®

âœ… è¿ç§»æ–‡ä»¶

ä¸éœ€è¦çš„æ˜¯ï¼š

âŒ åº”ç”¨ç¨‹åºä¸­çš„ DI æ³¨å†Œ (AddInfrastructure)

âŒ åº”ç”¨ç¨‹åºå¯åŠ¨

2. ä¸ºä»€ä¹ˆæ²¡æœ‰ AddInfrastructure ä¹Ÿèƒ½ç”Ÿæˆæ•°æ®åº“ï¼Ÿ

```
å› ä¸º EF Core è¿ç§»å·¥å…· å’Œ åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ï¼š

åœºæ™¯	             é…ç½®æ¥æº	                                   DbContext åˆ›å»ºæ–¹å¼
EF Coreè¿ç§»å·¥å…·	    è®¾è®¡æ—¶å·¥å‚ (ProjectContextDesignTimeFactory)	ç›´æ¥å®ä¾‹åŒ–
åº”ç”¨ç¨‹åºè¿è¡Œæ—¶	     DI å®¹å™¨ (AddInfrastructure)                 	ä¾èµ–æ³¨å…¥
```

3. å„ä»£ç çš„ä½œç”¨åˆ†æ

ProjectContext.cs - å¿…éœ€
ProjectContextDesignTimeFactory.cs - è¿ç§»æ—¶å¿…éœ€

# é—ç•™é—®é¢˜

å®¢æˆ·çš„çº¿ä¸Šæ•°æ®åº“è¦å¦‚ä½• æ›´æ–°å‘¢
æˆ‘ç°åœ¨æœ¬åœ°å¯¹æ•°æ®åº“çš„åˆå§‹åŒ– è¿™ä¹ˆå»æ“ä½œå®Œå…¨æ²¡æœ‰é—®é¢˜ï¼Œé‚£å®¢æˆ·é‚£é‡Œçš„çº¿ä¸Šæ•°æ®åº“è¦æ€ä¹ˆåŠå‘¢ï¼Œå¦‚æœå®¢æˆ·é‚£é‡Œæ˜¯ å®Œå…¨å±äº æ–°çš„ç¯å¢ƒï¼Œé‚£è¿˜å¯ä»¥ï¼Œä»æ— åˆ°æœ‰ï¼Œå¥½åƒè¿˜å¯ä»¥ï¼Œä½†æ˜¯å®¢æˆ·é‚£é‡Œä¹Ÿä¸èƒ½è®©æ‰§è¡Œ dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure
dotnet ef database update --startup-project . --project ../Project.Infrastructure è¿™äº›å‘½ä»¤å‘€

# æ–¹æ¡ˆ

ç”Ÿæˆ SQL è„šæœ¬ï¼ˆæœ€æ¨èï¼‰
åœ¨å¼€å‘ç¯å¢ƒç”Ÿæˆè¿ç§»è„šæœ¬

```
# ç”Ÿæˆå®Œæ•´çš„è¿ç§»è„šæœ¬
dotnet ef migrations script --startup-project . --project ../Project.Infrastructure --output migration.sql
```

éœ€è¦å®ç°æ‰§è¡Œ
dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure

# å®Œæ•´çš„å·¥ä½œæµç¨‹

```
# 1. åˆ›å»ºè¿ç§»ï¼ˆç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼‰
dotnet ef migrations add InitProjectDb --startup-project . --project ../Project.Infrastructure

# 2. ç”Ÿæˆ SQL è„šæœ¬
dotnet ef migrations script --startup-project . --project ../Project.Infrastructure --output migration.sql

# 3. åº”ç”¨è¿ç§»ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
dotnet ef database update --startup-project . --project ../Project.Infrastructure
```

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç­–ç•¥

ç­–ç•¥ 1ï¼šä¸€æ¬¡æ€§å®Œæ•´éƒ¨ç½²ï¼ˆæ–°é¡¹ç›®ï¼‰

```
# å¼€å‘ç¯å¢ƒ
dotnet ef migrations add InitProjectDb
dotnet ef migrations script --idempotent --output full_deployment.sql

# äº¤ä»˜ full_deployment.sql ç»™å®¢æˆ·
```

ç­–ç•¥ 2ï¼šå¢é‡éƒ¨ç½²ï¼ˆå·²æœ‰é¡¹ç›®æ›´æ–°ï¼‰

```
# å¼€å‘ç¯å¢ƒï¼šåˆ›å»ºæ–°è¿ç§»
dotnet ef migrations add AddNewFeature
dotnet ef migrations script FromPreviousMigration --idempotent --output incremental_update.sql

# äº¤ä»˜ incremental_update.sql ç»™å®¢æˆ·
```

# ç­–ç•¥ 1ï¼šä¸€æ¬¡æ€§å®Œæ•´éƒ¨ç½²ï¼ˆæ–°é¡¹ç›®ï¼‰ æˆ‘è§‰å¾—è¿˜å¥½ï¼Œä½†æ˜¯ ç­–ç•¥ 2ï¼šå¢é‡éƒ¨ç½²ï¼ˆå·²æœ‰é¡¹ç›®æ›´æ–°ï¼‰ ï¼Œé‚£å°±æ˜¯æ¯ä¸€æ¬¡æ•°æ®åº“æ›´æ–°çš„ migration éƒ½å¾—ä¿å­˜äº†å‘€ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½å¯¹æ•°æ®æ›´æ”¹å¾ˆé¢‘ç¹å‘€ï¼Œ

ç­–ç•¥ 1ï¼šå®šæœŸåˆå¹¶è¿ç§»ï¼ˆæ¨èï¼‰åœ¨å¼€å‘é˜¶æ®µé¢‘ç¹åˆ›å»ºè¿ç§»ï¼Œå‘å¸ƒå‰åˆå¹¶

```
# å¼€å‘æœŸé—´ï¼šé¢‘ç¹åˆ›å»ºè¿ç§»
dotnet ef migrations Add AddUserEmailIndex
dotnet ef migrations Add FixProjectDescriptionLength
dotnet ef migrations Add AddAuditColumns

# å‘å¸ƒå‰ï¼šåˆ é™¤æ‰€æœ‰è¿ç§»ï¼Œåˆ›å»ºä¸€ä¸ªåˆå¹¶è¿ç§»
dotnet ef migrations remove --force
dotnet ef migrations remove --force
dotnet ef migrations remove --force
dotnet ef migrations add Release_v1.2.0
```

# æˆ‘ä»¬å°±èµ°ç­–ç•¥ 1ï¼šå®šæœŸåˆå¹¶è¿ç§»ï¼ˆæ¨èï¼‰ ï¼Œè¿™ä¸ªæ–¹æ¡ˆå“ˆï¼Œæˆ‘æƒ³çŸ¥é“çŸ¥é“ä¸€ä¸‹å‘€ï¼Œ å‘å¸ƒå‰ï¼šåˆ é™¤æ‰€æœ‰è¿ç§»ï¼Œåˆ›å»ºä¸€ä¸ªåˆå¹¶è¿ç§»ï¼Œæˆ‘éƒ½ç»™åˆ é™¤äº†ï¼Œç„¶å dotnet ef migrations add Release_v1.2.0 è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Œæˆ‘æ²¡ç†è§£ï¼Œæ­¤æ—¶æˆ‘æœ¬åœ°æ•°æ®åº“å·²ç»æ˜¯ æœ€æ–°çš„äº†å‘€ï¼Œæˆ‘å†æ‰§è¡Œ dotnet ef migrations add Release_v1.2.0 ä¼šæ€ä¹ˆæ ·ç”Ÿæˆè¿ç§»æ–‡ä»¶å‘¢

æ­¥éª¤ 1ï¼šåˆ é™¤è¿ç§»æ–‡ä»¶å‰çš„çŠ¶æ€
Migrations/
â”œâ”€â”€ 20241201000000_InitialCreate.cs
â”œâ”€â”€ 20241202000000_AddUserEmail.cs  
â”œâ”€â”€ 20241203000000_AddProjectStatus.cs
â”œâ”€â”€ 20241204000000_FixDescriptionLength.cs
â””â”€â”€ ProjectContextModelSnapshot.cs â† è¿™ä¸ªæ–‡ä»¶å¾ˆé‡è¦ï¼
æ­¥éª¤ 2ï¼šåˆ é™¤è¿ç§»æ–‡ä»¶ï¼ˆä¿ç•™å¿«ç…§ï¼‰

```
# åˆ é™¤æ‰€æœ‰è¿ç§»æ–‡ä»¶ï¼Œä½†å¿«ç…§æ–‡ä»¶ä¼šè‡ªåŠ¨ä¿ç•™
find Project.Infrastructure/Migrations -name "*.cs" ! -name "*Snapshot.cs" -delete
```

æ­¥éª¤ 3ï¼šæ‰§è¡Œ dotnet ef migrations add Release_v1.2.0
è¿™æ—¶ EF Core ä¼šï¼š

è¯»å–å¿«ç…§æ–‡ä»¶ï¼šäº†è§£å½“å‰æ•°æ®åº“åº”è¯¥æ˜¯ä»€ä¹ˆç»“æ„

ä¸ç©ºçŠ¶æ€æ¯”è¾ƒï¼šå› ä¸ºåˆ é™¤äº†æ‰€æœ‰è¿ç§»ï¼ŒEF Core è®¤ä¸ºæ•°æ®åº“æ˜¯ç©ºçš„

ç”Ÿæˆå®Œæ•´è¿ç§»ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰è¡¨ç»“æ„åˆ›å»ºçš„è¿ç§»

# æˆ‘å…ˆç†è§£ä¸€ä¸‹å“ˆï¼Œæˆ‘æŠŠè¿ç§»æ–‡ä»¶éƒ½åˆ é™¤äº†ï¼Œä¿ç•™å¿«ç…§æ–‡ä»¶åï¼Œæ­¤æ—¶å†å»æ‰§è¡Œ dotnet ef migrations add Release_v1.2.0 ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼Œæ„æ€æ˜¯è¯´å°±æ˜¯æŠŠä¹‹å‰çš„è¿ç§»éƒ½åˆå¹¶åˆ°ä¸€èµ·äº†å“ˆ

å®Œå…¨æ­£ç¡®ï¼ä½ çš„ç†è§£ 100%å‡†ç¡®ï¼ ğŸ‰

# å¥½ï¼Œé‚£å¦‚æ­¤ æˆ‘è§‰å¾—ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜äº†ï¼Œåªéœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„äººï¼Œå®šæœŸçš„å»åšè¿™ä¸ªäº‹æƒ…å°±å¯ä»¥äº†
