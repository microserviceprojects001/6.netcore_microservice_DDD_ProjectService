# 初始化数据库遇到的问题

dotnet ef migrations add initProjectDb

在 Project.API 中代码如下：

```
var connectionString = builder.Configuration.GetConnectionString("MySQLProject");
Console.WriteLine($"DB Server: {connectionString}");

builder.Services.AddDbContext<ProjectContext>(options =>
    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString))
);
```

执行数据库初始化时候报错

```
No DbContext was found in assembly 'Project.API'. Ensure that you're using the correct assembly and that the typt the type is neither abstract nor generic.
```

# 原因

这个错误是因为 dotnet ef migrations 命令默认在当前程序集（Project.API）中查找 DbContext，但您的
ProjectContext
在
Project.Infrastructure
程序集中。

# 方案(不 work)

```
dotnet ef migrations add initProjectDb --project Project.Infrastructure --startup-project Project.API
```

# 遇到问题

嗯，我现在是在 Project.API 中执行了

dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure --context ProjectContext

这个命令，现在报错 Unable to create a 'DbContext' of type 'ProjectContext'. The exception 'Unable to resolve service for type
'Microsoft.EntityFrameworkCore.DbContextOptions`1[Project.Infrastructure.ProjectContext]' while attempting
to activate 'Project.Infrastructure.ProjectContext'.' was thrown while attempting to create an instance. For the different patterns supported at design time, see https://go.microsoft.com/fwlink/?linkid=851728

# 经过添加 ProjectContextDesignTimeFactory 后执行以下命令，能成功的更新本地数据库了

```
D:\Code\1.microservice\2.netcore_microservice_userService\Project\Project.API

Server=localhost;port=3307;Database=beta_project;User=abel;Password=acsdev312!@;

dotnet ef migrations add initProjectDb --startup-project . --project ../Project.Infrastructure
dotnet ef database update --startup-project . --project ../Project.Infrastructure

```

此时如果 我把数据库连接直接换成 阿里云服务器的数据库连接，然后执行以上的 update 命令，是可以更新数据库的
Server=8.140.59.193;port=3307;Database=beta_project;User=abel;Password=acsdev312!@;

# 解释一下 EF Core 数据库生成的工作原理和必要条件

1. 核心必要条件
   数据库生成真正需要的是：

✅ DbContext 类

✅ 数据库连接字符串

✅ 数据库提供程序配置

✅ 迁移文件

不需要的是：

❌ 应用程序中的 DI 注册 (AddInfrastructure)

❌ 应用程序启动

2. 为什么没有 AddInfrastructure 也能生成数据库？

```
因为 EF Core 迁移工具 和 应用程序运行时 是两个独立的上下文：

场景	             配置来源	                                   DbContext 创建方式
EF Core迁移工具	    设计时工厂 (ProjectContextDesignTimeFactory)	直接实例化
应用程序运行时	     DI 容器 (AddInfrastructure)                 	依赖注入
```

3. 各代码的作用分析

ProjectContext.cs - 必需
ProjectContextDesignTimeFactory.cs - 迁移时必需
