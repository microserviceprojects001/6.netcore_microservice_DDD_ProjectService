# ç»“åˆä¸šåŠ¡éœ€æ±‚æ¥è®¤è¯†å„ç§åç§°

```
  ç•Œé™ä¸Šä¸‹æ–‡
  å®ä½“
  å€¼å¯¹è±¡
  èšåˆ
  èšåˆæ ¹
  ä»“å‚¨-æŒä¹…åŒ–
```

![alt text](<../æˆªå›¾/0.DDDå·¥ä½œæµç¨‹ .png>)

1. ç•Œé™ä¸Šä¸‹æ–‡ - Bounded Context

## æ ¸å¿ƒæ€æƒ³

å¤§å‹ç³»ç»Ÿè¢«åˆ’åˆ†ä¸ºå¤šä¸ªç›¸å¯¹ç‹¬ç«‹çš„ä¸šåŠ¡è¾¹ç•Œï¼Œæ¯ä¸ªè¾¹ç•Œå†…æœ‰è‡ªå·±çš„é¢†åŸŸæ¨¡å‹å’Œé€šç”¨è¯­è¨€

## ç”ŸåŠ¨æ¯”å–»

æƒ³è±¡ä¸€ä¸ªåŒ»é™¢ï¼š

- æŒ‚å·ç§‘ï¼šç—…äºº = {å§“å, ç—‡çŠ¶, æŒ‚å·æ—¶é—´}

- è¯æˆ¿ï¼šç—…äºº = {å§“å, è¯å“æ¸…å•, è¿‡æ•å²}

- è´¢åŠ¡ç§‘ï¼šç—…äºº = {å§“å, è´¦æˆ·ä½™é¢, ç¼´è´¹è®°å½•}

æ¯ä¸ªç§‘å®¤å¯¹"ç—…äºº"çš„ç†è§£ä¸åŒï¼Œè¿™å°±æ˜¯ä¸åŒçš„ç•Œé™ä¸Šä¸‹æ–‡ã€‚

## å®é™…æ¡ˆä¾‹ï¼šç”µå•†ç³»ç»Ÿ

```
// å•†å“ä¸Šä¸‹æ–‡ - å…³æ³¨å•†å“ä¿¡æ¯
public class Product {
    private ProductId id;
    private String name;
    private Price price;
    private Inventory inventory;
}

// è®¢å•ä¸Šä¸‹æ–‡ - å…³æ³¨è´­ä¹°æµç¨‹
public class Order {
    private OrderId id;
    private List<OrderItem> items;
    private OrderStatus status;
}
```

2. å®ä½“ - Entity

## æ ¸å¿ƒç‰¹å¾

- æœ‰å”¯ä¸€æ ‡è¯†ï¼šé€šè¿‡ ID åŒºåˆ†ä¸åŒå¯¹è±¡

- æœ‰ç”Ÿå‘½å‘¨æœŸï¼šä¼šç»å†çŠ¶æ€å˜åŒ–

- å¯å˜ï¼šå±æ€§å¯ä»¥ä¿®æ”¹

ä¾‹å­

```
public class User {
    private UserId id;      // å”¯ä¸€æ ‡è¯†
    private String name;    // å¯ä¿®æ”¹
    private String email;   // å¯ä¿®æ”¹

    // è¡Œä¸ºæ–¹æ³•
    public void changeEmail(String newEmail) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (!isValidEmail(newEmail)) {
            throw new InvalidEmailException();
        }
        this.email = newEmail;
    }
}

```

3. å€¼å¯¹è±¡ - Value Object

## æ ¸å¿ƒç‰¹å¾

- æ— å”¯ä¸€æ ‡è¯†ï¼šé€šè¿‡æ‰€æœ‰å±æ€§å€¼æ¥åŒºåˆ†

- ä¸å¯å˜ï¼šåˆ›å»ºåä¸èƒ½ä¿®æ”¹

- å¯æ›¿æ¢ï¼šç›´æ¥æ›¿æ¢æ•´ä¸ªå¯¹è±¡
  ä¾‹å­

```
public class Address {
    private final String province;  // finalè¡¨ç¤ºä¸å¯å˜
    private final String city;
    private final String street;
    private final String zipCode;

    // åŸºäºæ‰€æœ‰å±æ€§åˆ¤æ–­ç›¸ç­‰æ€§
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Address address = (Address) o;
        return Objects.equals(province, address.province) &&
               Objects.equals(city, address.city) &&
               Objects.equals(street, address.street) &&
               Objects.equals(zipCode, address.zipCode);
    }
}
```

ğŸ¯ 4. èšåˆ - Aggregate & èšåˆæ ¹ - Aggregate Root
è¿™æ˜¯ DDD ä¸­æœ€å…³é”®çš„æ¦‚å¿µï¼

## æ ¸å¿ƒæ€æƒ³

å°†é«˜åº¦ç›¸å…³çš„å¯¹è±¡ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªä¸€è‡´æ€§è¾¹ç•Œ

## æƒ³è±¡ä¸€ä¸ªè®¢å•ï¼š

- è®¢å•æœ¬èº«ï¼ˆèšåˆæ ¹ï¼‰

- è®¢å•é¡¹ï¼ˆå†…éƒ¨å®ä½“ï¼‰

- é…é€åœ°å€ï¼ˆå€¼å¯¹è±¡ï¼‰
  å¤–éƒ¨åªèƒ½é€šè¿‡"è®¢å•"æ¥æ“ä½œé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿ï¼Œä¸èƒ½ç›´æ¥æ“ä½œè®¢å•é¡¹ã€‚

## ä»£ç ç¤ºä¾‹

```
// èšåˆæ ¹ - Order
// èšåˆæ ¹
public class Order {
    private OrderId id;
    private CustomerId customerId;
    private OrderStatus status;
    private Address shippingAddress;     // å€¼å¯¹è±¡
    private List<OrderItem> orderItems;  // å†…éƒ¨å®ä½“åˆ—è¡¨

    // ä¸šåŠ¡æ–¹æ³•ï¼šæ›´æ–°é…é€åœ°å€ï¼ˆå€¼å¯¹è±¡æ›¿æ¢ï¼‰
    public void changeShippingAddress(Address newAddress) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (this.status == OrderStatus.SHIPPED) {
            throw new OrderAlreadyShippedException();
        }
        // æ•´ä½“æ›¿æ¢å€¼å¯¹è±¡
        this.shippingAddress = newAddress;
    }

    // ä¸šåŠ¡æ–¹æ³•ï¼šæ·»åŠ è®¢å•é¡¹ï¼ˆå†…éƒ¨å®ä½“æ“ä½œï¼‰
    public void addOrderItem(ProductId productId, int quantity, Money price) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (this.status != OrderStatus.CREATED) {
            throw new OrderCannotBeModifiedException();
        }

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        Optional<OrderItem> existing = findOrderItemByProduct(productId);
        if (existing.isPresent()) {
            existing.get().updateQuantity(quantity);
        } else {
            OrderItem newItem = OrderItem.create(productId, quantity, price);
            this.orderItems.add(newItem);
        }

        // ç»´æŠ¤èšåˆå†…çš„ä¸€è‡´æ€§
        this.ensureOrderInvariant();
    }

    // ç§æœ‰æ–¹æ³•ï¼šæŸ¥æ‰¾å†…éƒ¨å®ä½“
    private Optional<OrderItem> findOrderItemByProduct(ProductId productId) {
        return orderItems.stream()
            .filter(item -> item.getProductId().equals(productId))
            .findFirst();
    }
}

// å€¼å¯¹è±¡ - Address
public class Address {
    private final String province;
    private final String city;
    private final String street;
    private final String zipCode;

    public Address(String province, String city, String street, String zipCode) {
        this.province = province;
        this.city = city;
        this.street = street;
        this.zipCode = zipCode;
    }

    // å€¼å¯¹è±¡ç›¸ç­‰æ€§æ¯”è¾ƒ
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Address)) return false;
        Address address = (Address) o;
        return Objects.equals(province, address.province) &&
               Objects.equals(city, address.city) &&
               Objects.equals(street, address.street) &&
               Objects.equals(zipCode, address.zipCode);
    }
}

// å†…éƒ¨å®ä½“ - OrderItem
public class OrderItem {
    private OrderItemId id;
    private ProductId productId;
    private int quantity;
    private Money price;

    // å†…éƒ¨å®ä½“å¯ä»¥æœ‰è‡ªå·±çš„è¡Œä¸º
    public void updateQuantity(int newQuantity) {
        if (newQuantity <= 0) {
            throw new InvalidQuantityException();
        }
        this.quantity = newQuantity;
    }
}
```

## èšåˆçš„é‡è¦è§„åˆ™ï¼š

- èšåˆæ ¹æ˜¯å”¯ä¸€å…¥å£ï¼šå¤–éƒ¨åªèƒ½é€šè¿‡èšåˆæ ¹æ¥è®¿é—®èšåˆå†…éƒ¨

- å¼•ç”¨å…¶ä»–èšåˆï¼šåªèƒ½é€šè¿‡ ID å¼•ç”¨ï¼Œä¸èƒ½ç›´æ¥æŒæœ‰å¯¹è±¡å¼•ç”¨

- äº‹åŠ¡è¾¹ç•Œï¼šä¸€ä¸ªèšåˆå°±æ˜¯ä¸€ä¸ªäº‹åŠ¡è¾¹ç•Œ

- æ•´ä½“ä¿å­˜ï¼šä¿å­˜èšåˆæ—¶ï¼Œæ•´ä¸ªèšåˆä¸€èµ·ä¿å­˜

5. ä»“å‚¨ - Repository

## æ ¸å¿ƒèŒè´£

åªé’ˆå¯¹èšåˆæ ¹è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ

## ä¾‹å­

```
// ä»“å‚¨æ¥å£ - åœ¨é¢†åŸŸå±‚å®šä¹‰
public interface OrderRepository {
    // åªå¤„ç†èšåˆæ ¹Order
    Optional<Order> findById(OrderId id);
    void save(Order order);
    void delete(Order order);

    // ä¸ä¼šå‡ºç°è¿™æ ·çš„æ–¹æ³•ï¼
    // âŒ void saveOrderItem(OrderItem item) - é”™è¯¯ï¼
}

// åº”ç”¨æœåŠ¡ä¸­ä½¿ç”¨
public class OrderApplicationService {
    private OrderRepository orderRepository;

    public void addItemToOrder(OrderId orderId, ProductId productId, int quantity) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException());

        // é€šè¿‡èšåˆæ ¹æ“ä½œ
        order.addItem(productId, quantity, productService.getPrice(productId));

        // ä¿å­˜æ•´ä¸ªèšåˆ
        orderRepository.save(order);
    }
}
```

6. é¢†åŸŸäº‹ä»¶ - Domain Event

## æ ¸å¿ƒç‰¹å¾

- è¡¨ç¤ºå·²å‘ç”Ÿçš„äº‹æƒ…

- åŒ…å«ä¸šåŠ¡æ„ä¹‰

- å¯è¢«å…¶ä»–ç»„ä»¶ç›‘å¬

## ä¾‹å­

```
public class OrderPaidEvent {
    private final OrderId orderId;
    private final CustomerId customerId;
    private final Money amount;
    private final Instant occurredOn;

    public OrderPaidEvent(OrderId orderId, CustomerId customerId, Money amount) {
        this.orderId = orderId;
        this.customerId = customerId;
        this.amount = amount;
        this.occurredOn = Instant.now();
    }
}

// åœ¨èšåˆä¸­å‘å¸ƒäº‹ä»¶
public class Order {
    public void pay(Payment payment) {
        this.status = OrderStatus.PAID;
        this.paymentTime = Instant.now();

        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        this.addDomainEvent(new OrderPaidEvent(this.id, this.customerId, this.totalAmount));
    }
}
```
