# é¢†åŸŸäº‹ä»¶æ˜¯ä¼šè¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“é‡Œé¢å— ï¼Œ

# ğŸš« é¢†åŸŸäº‹ä»¶ä¸ä¼šè¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“

```
var domainEvents = _context.ChangeTracker
    .Entries<Entity>()
    .SelectMany(x => x.Entity.DomainEvents)
    .ToList();
```

è¿™ä¸æ˜¯ä»æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œæ˜¯ä» EF Core çš„å˜æ›´è·Ÿè¸ªå™¨ä¸­è·å–å†…å­˜ä¸­çš„é¢†åŸŸäº‹ä»¶ï¼

1. é¢†åŸŸäº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

```
// æ­¥éª¤1ï¼šåœ¨é¢†åŸŸå¯¹è±¡ä¸­äº§ç”Ÿäº‹ä»¶ï¼ˆå†…å­˜ä¸­ï¼‰
public class Order : Entity
{
    public void Pay()
    {
        Status = OrderStatus.Paid;
        // åœ¨å†…å­˜ä¸­æ·»åŠ é¢†åŸŸäº‹ä»¶
        AddDomainEvent(new OrderPaidEvent(Id, TotalAmount));
    }
}

// æ­¥éª¤2ï¼šEF Coreè·Ÿè¸ªè¿™äº›å¯¹è±¡
var order = await _orderRepository.GetByIdAsync(orderId);  // EF Coreå¼€å§‹è·Ÿè¸ª
order.Pay();  // äº§ç”Ÿ OrderPaidEventï¼Œäº‹ä»¶å­˜å‚¨åœ¨ order.DomainEvents ä¸­

// æ­¥éª¤3ï¼šä»å˜æ›´è·Ÿè¸ªå™¨è·å–äº‹ä»¶ï¼ˆä¸æ˜¯ä»æ•°æ®åº“ï¼ï¼‰
var domainEvents = _context.ChangeTracker
    .Entries<Entity>()  // è·å–æ‰€æœ‰è¢«è·Ÿè¸ªçš„å®ä½“
    .SelectMany(x => x.Entity.DomainEvents)  // ä»å®ä½“å¯¹è±¡ä¸­æå–äº‹ä»¶
    .ToList();  // åœ¨å†…å­˜ä¸­åˆ›å»ºäº‹ä»¶åˆ—è¡¨
```

2. å†…å­˜ä¸­çš„æ•°æ®ç»“æ„

```
å†…å­˜ä¸­çš„å¯¹è±¡å…³ç³»ï¼š
_context (ApplicationDbContext)
  â†“
ChangeTracker (è·Ÿè¸ªæ‰€æœ‰å®ä½“çŠ¶æ€å˜åŒ–)
  â†“
Entries<Entity> (æ‰€æœ‰è¢«è·Ÿè¸ªçš„å®ä½“å¯¹è±¡)
  â†“
[Orderå¯¹è±¡1] â†’ DomainEvents: [OrderCreatedEvent, OrderPaidEvent]
[Orderå¯¹è±¡2] â†’ DomainEvents: [ShippingAddressChangedEvent]
[å…¶ä»–å®ä½“]   â†’ DomainEvents: []
```

3. å®Œæ•´çš„æ•°æ®æµ

```
// 1. åº”ç”¨æœåŠ¡è°ƒç”¨
public async Task PayOrder(OrderId orderId)
{
    var order = await _orderRepository.GetByIdAsync(orderId);  // ä»æ•°æ®åº“åŠ è½½
    order.Pay();  // åœ¨å†…å­˜ä¸­ä¿®æ”¹çŠ¶æ€å¹¶æ·»åŠ äº‹ä»¶

    // æ­¤æ—¶ï¼š
    // - orderå¯¹è±¡åœ¨å†…å­˜ä¸­
    // - OrderPaidEventåœ¨order.DomainEventsä¸­ï¼ˆå†…å­˜ï¼‰
    // - EF Coreçš„ChangeTrackerè·Ÿè¸ªç€orderå¯¹è±¡çš„å˜åŒ–

    await _orderRepository.SaveChangesAsync();  // ä¿å­˜å¹¶å‘å¸ƒäº‹ä»¶
}

// 2. SaveChangesAsyncå†…éƒ¨
public async Task SaveChangesAsync(CancellationToken cancellationToken = default)
{
    // ä»å†…å­˜ä¸­çš„å˜æ›´è·Ÿè¸ªå™¨è·å–äº‹ä»¶
    var domainEvents = _context.ChangeTracker
        .Entries<Entity>()
        .SelectMany(x => x.Entity.DomainEvents)  // ä»å†…å­˜å¯¹è±¡è·å–ï¼
        .ToList();

    // ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆé¢†åŸŸäº‹ä»¶ä¸ä¿å­˜ï¼ï¼‰
    await _context.SaveChangesAsync(cancellationToken);

    // å‘å¸ƒå†…å­˜ä¸­çš„äº‹ä»¶
    foreach (var domainEvent in domainEvents)
    {
        await _domainEventPublisher.Publish(domainEvent, cancellationToken);
    }

    // æ¸…ç©ºå†…å­˜ä¸­çš„äº‹ä»¶
    ClearDomainEvents();
}
```

[NotMapped] ç‰¹æ€§æ˜ç¡®è¡¨ç¤ºï¼šè¿™ä¸ªå±æ€§åªå­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¸åº”è¯¥æ˜ å°„åˆ°æ•°æ®åº“è¡¨ï¼

# ğŸ¯ æ­£ç¡®ç†è§£ ChangeTracker

ChangeTracker çš„ä½œç”¨ï¼š

```
// ChangeTracker æ˜¯EF Coreçš„å†…å­˜ç®¡ç†å™¨
// å®ƒè·Ÿè¸ªï¼šå“ªäº›å¯¹è±¡è¢«åŠ è½½ã€ä¿®æ”¹ã€æ·»åŠ ã€åˆ é™¤

var order = await _context.Orders.FindAsync(id);  // ChangeTrackerå¼€å§‹è·Ÿè¸ª
order.Status = OrderStatus.Paid;                  // ChangeTrackeræ ‡è®°ä¸ºModified
order.AddDomainEvent(new OrderPaidEvent());       // å†…å­˜ä¸­æ·»åŠ äº‹ä»¶ï¼ˆChangeTrackerçŸ¥é“ï¼‰

// ä»ChangeTrackerè·å–çš„æ˜¯å†…å­˜ä¸­çš„å¯¹è±¡å¼•ç”¨ï¼Œä¸æ˜¯æ•°æ®åº“æ•°æ®ï¼
var trackedOrder = _context.ChangeTracker.Entries<Order>().First();
var events = trackedOrder.Entity.DomainEvents;  // ä»å†…å­˜å¯¹è±¡è·å–
```

# âœ… æ€»ç»“

å›ç­”ä½ çš„é—®é¢˜ï¼šé¢†åŸŸäº‹ä»¶ä¸ä¼šè¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼

æ¥æºï¼šä» EF Core çš„ ChangeTracker è·å–å†…å­˜ä¸­çš„äº‹ä»¶

å­˜å‚¨ï¼šäº‹ä»¶åªå­˜åœ¨äºå†…å­˜ä¸­ï¼Œå¤„ç†å®Œæˆåè¢«ä¸¢å¼ƒ

è¯æ®ï¼š[NotMapped] ç‰¹æ€§æ˜ç¡®é˜»æ­¢äº†æ•°æ®åº“æŒä¹…åŒ–

è®¾è®¡æ„å›¾ï¼šé¢†åŸŸäº‹ä»¶æ˜¯ä¸šåŠ¡æµç¨‹çš„å‰¯äº§å“ï¼Œä¸æ˜¯éœ€è¦æŒä¹…åŒ–çš„æ ¸å¿ƒæ•°æ®

# æˆ‘æœ‰ä¸€ä¸ªç–‘é—®ï¼Œæ¯”æ–¹è¯´ä¸€ä¸ªç”¨æˆ·åœ¨æ–°å»º order ä¼šæ·»åŠ é¢†åŸŸäº‹ä»¶ ordercreated eventï¼Œå¦ä¸€ä¸ªç”¨æˆ·åœ¨æ”¯ä»˜ä»–çš„è®¢å•ï¼Œä¼šå‘å¸ƒ OderPaiedEvent é¢†åŸŸäº‹ä»¶ï¼Œå¥½å˜ï¼Œ

           var domainEvents = \_context.ChangeTracker

                .Entries<Entity>()
                .SelectMany(x => x.Entity.DomainEvents)
                .ToList();

            _logger.LogDebug("æ”¶é›†åˆ° {EventCount} ä¸ªé¢†åŸŸäº‹ä»¶", domainEvents.Count);

            // 2. ä¿å­˜æ•°æ®å˜æ›´
            await _context.SaveChangesAsync(cancellationToken);

            // 3. å‘å¸ƒé¢†åŸŸäº‹ä»¶
            if (domainEvents.Any())
            {
                await _domainEventPublisher.PublishAsync(domainEvents, cancellationToken);
            }

å½“ä»–ä»¬å„è‡ªè°ƒç”¨äº† savechange æ–¹æ³•ï¼Œè¿™ä¸ª publishasync æ˜¯å‘å¸ƒäº†æ‰€æœ‰äººçš„ Event äº†å—ï¼Œ

# éå¸¸å¥½çš„é—®é¢˜ï¼ ä½ çš„æ‹…å¿ƒæ˜¯æœ‰é“ç†çš„ï¼Œä½†ç­”æ¡ˆæ˜¯ï¼šä¸ä¼šå‘å¸ƒæ‰€æœ‰äººçš„äº‹ä»¶ï¼Œåªä¼šå‘å¸ƒå½“å‰å·¥ä½œå•å…ƒä¸­çš„äº‹ä»¶ã€‚

ğŸ¯ å…³é”®æ¦‚å¿µï¼šDbContext çš„å·¥ä½œå•å…ƒæ¨¡å¼
åœ¨å…¸å‹çš„ Web åº”ç”¨ä¸­ï¼Œæ¯ä¸ª HTTP è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ DbContext å®ä¾‹ï¼Œè¿™æ„å‘³ç€ï¼š

```
// ç”¨æˆ·Açš„è¯·æ±‚
public class OrderController
{
    public async Task<IActionResult> CreateOrder()
    {
        using var scope = _serviceProvider.CreateScope();
        var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
        var repository = new OrderRepository(context, ...);

        // ç”¨æˆ·Aåˆ›å»ºè®¢å•
        var orderA = Order.Create(...);
        await repository.AddAsync(orderA);
        await repository.SaveChangesAsync();  // åªå‘å¸ƒorderAçš„äº‹ä»¶
    }
}

// ç”¨æˆ·Bçš„è¯·æ±‚ï¼ˆåŒæ—¶å‘ç”Ÿï¼‰
public class OrderController
{
    public async Task<IActionResult> PayOrder()
    {
        using var scope = _serviceProvider.CreateScope();
        var context = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
        var repository = new OrderRepository(context, ...);

        // ç”¨æˆ·Bæ”¯ä»˜è®¢å•
        var orderB = await repository.GetByIdAsync(...);
        orderB.Pay();
        await repository.SaveChangesAsync();  // åªå‘å¸ƒorderBçš„äº‹ä»¶
    }
}
```

ğŸ” è¯¦ç»†åˆ†æä½ çš„åœºæ™¯
åœºæ™¯ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶æ“ä½œ

```
// æ—¶é—´ç‚¹ T1: ç”¨æˆ·Aå¼€å§‹åˆ›å»ºè®¢å•
var contextA = new ApplicationDbContext();  // åˆ›å»ºDbContextå®ä¾‹A
var repositoryA = new OrderRepository(contextA, ...);

var orderA = Order.Create(customerA, address, items);
// orderA.DomainEvents: [OrderCreatedEvent]

await repositoryA.AddAsync(orderA);

// æ—¶é—´ç‚¹ T2: ç”¨æˆ·Bå¼€å§‹æ”¯ä»˜è®¢å•
var contextB = new ApplicationDbContext();  // åˆ›å»ºDbContextå®ä¾‹B
var repositoryB = new OrderRepository(contextB, ...);

var orderB = await repositoryB.GetByIdAsync(orderIdB);
orderB.Pay();
// orderB.DomainEvents: [OrderPaidEvent]

// æ—¶é—´ç‚¹ T3: ç”¨æˆ·Aä¿å­˜
await repositoryA.SaveChangesAsync();
// contextA.ChangeTracker åªåŒ…å« orderA
// å‘å¸ƒ: [OrderCreatedEvent] â† åªæœ‰ç”¨æˆ·Açš„äº‹ä»¶ï¼

// æ—¶é—´ç‚¹ T4: ç”¨æˆ·Bä¿å­˜
await repositoryB.SaveChangesAsync();
// contextB.ChangeTracker åªåŒ…å« orderB
// å‘å¸ƒ: [OrderPaidEvent] â† åªæœ‰ç”¨æˆ·Bçš„äº‹ä»¶ï¼
```

ğŸ—ï¸ ä¾èµ–æ³¨å…¥é…ç½®ç¡®ä¿éš”ç¦»

```
// Program.cs
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString),
    ServiceLifetime.Scoped  // ğŸ¯ å…³é”®ï¼šæ¯ä¸ªè¯·æ±‚ä¸€ä¸ªå®ä¾‹
);

builder.Services.AddScoped<IOrderRepository, OrderRepository>();
```

ğŸ§ª éªŒè¯éš”ç¦»æ€§
è®©æˆ‘ä»¬é€šè¿‡ä»£ç éªŒè¯ï¼š

```
[Test]
public async Task TwoConcurrentUsers_ShouldHaveIsolatedDomainEvents()
{
    // æ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·çš„DbContext
    var contextUserA = new ApplicationDbContext();
    var contextUserB = new ApplicationDbContext();

    var repoUserA = new OrderRepository(contextUserA, ...);
    var repoUserB = new OrderRepository(contextUserB, ...);

    // ç”¨æˆ·Aåˆ›å»ºè®¢å•
    var orderA = Order.Create(customerA, address, items);
    await repoUserA.AddAsync(orderA);

    // ç”¨æˆ·Bæ”¯ä»˜è®¢å•
    var orderB = await repoUserB.GetByIdAsync(existingOrderId);
    orderB.Pay();

    // éªŒè¯å„è‡ªChangeTrackerçš„å†…å®¹
    var eventsUserA = contextUserA.ChangeTracker
        .Entries<Entity>()
        .SelectMany(e => e.Entity.DomainEvents)
        .ToList();

    var eventsUserB = contextUserB.ChangeTracker
        .Entries<Entity>()
        .SelectMany(e => e.Entity.DomainEvents)
        .ToList();

    // æ–­è¨€ï¼šå„è‡ªåªæœ‰è‡ªå·±çš„äº‹ä»¶
    Assert.That(eventsUserA, Has.Exactly(1).Items);      // åªæœ‰OrderCreatedEvent
    Assert.That(eventsUserB, Has.Exactly(1).Items);      // åªæœ‰OrderPaidEvent
    Assert.That(eventsUserA[0], Is.TypeOf<OrderCreatedEvent>());
    Assert.That(eventsUserB[0], Is.TypeOf<OrderPaidEvent>());
}
```
